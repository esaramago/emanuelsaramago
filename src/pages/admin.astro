---
import Layout from '@/layouts/layout.astro'
import Card from '@/components/Card.astro'
import Button from '@/components/Button.astro'
---

<Layout>

  <es-stack class="l-container">
    <h1 class="is-hidden-print">Admin</h1>

    <es-stack direction="row" break="tablet">
      <Card title="Criar fatura" template="default" className="is-hidden-print">
        <form id="invoiceForm">
          <div class="l-stack l-stack--s">
          <div>
            <label for="date">Fatura n.</label>
            <input
              required
              type="number"
              name="number"
              id="number"
              class="c-input"
              data-target="number"
            >
          </div>
          <div>
            <label for="date">Data</label>
            <input
              required
              type="date"
              name="date"
              id="date"
              class="c-input"
              data-target="date"
            >
          </div>
          <div>
              <label for="client">Cliente</label>
              <select required name="client-name" id="client" class="c-select">
                <option>Vesselindex</option>
                <option>Creative Code Solutions</option>
              </select>
          </div>
          <div>
              <label for="date">Mês data fatura</label>
              <input
              required
              type="month"
              name="month"
              id="month"
              class="c-input"
              >
          </div>
          <div>
              <label for="date">Horas</label>
              <input
              required
              type="number"
              name="hours"
              id="hours"
              class="c-input"
              min="0"
              step="1"
              >
          </div>
          <div>
              <label for="date">Valor/hora</label>
              <input
              required
              type="number"
              name="unit-price"
              id="hourlyRate"
              value="40"
              class="c-input"
              min="0"
              step="1"
              >
          </div>
          <Button type="submit" id="printButton" type="button">Imprimir</Button>
          </div>
        </form>
      </Card>
      <Card title="Fatura">
        <div class="invoice" id="invoice">
          <!-- Header -->
          <div class="invoice__header">
            <h1 class="invoice__title">INVOICE</h1>
            <div class="invoice__header-info">
              <div><strong>Invoice no.:</strong> <span data-invoice-number>[invoiceNumber]</span></div>
              <div><strong>Date:</strong> <span data-invoice-date>[date]</span></div>
            </div>
          </div>

          <es-stack direction="row">
            <!-- From Section -->
            <div grow="1">
              <div class="invoice__section-label">From Emanuel Saramago</div>
              <div class="invoice__address">
                <div>Emanuel Saramago</div>
                <div>Av. General Roçadas 141 2cv E</div>
                <div>1170-158 Lisboa, Portugal</div>
                <div>VAT: 217469183</div>
                <div>Phone: 00351 968 665 757</div>
                <div>Email: vi@emanuelsaramago.com</div>
              </div>
            </div>

            <!-- Billed To Section -->
            <div grow="1">
              <div class="invoice__section-label">Billed to</div>
              <div class="invoice__address">
                <div>Liengaard & Roschmann Aps</div>
                <div>Hollændervej 23B, 2 1855</div>
                <div>Frederiksberg C. Copenhagen, Denmark</div>
                <div>VAT: <span>38614177</span></div>
              </div>
            </div>
          </es-stack>

          <!-- Items Table -->
          <es-stack gap="s">
            <table>
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Unit price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td data-invoice-description>
                    Design and web development<br>
                    <span data-invoice-client-name>[clientName]</span>:
                    <span data-invoice-month>[month]</span>
                  </td>
                  <td>
                    <span data-invoice-unit-price>[unit-price]</span>€/h</td>
                  <td data-invoice-hours>[hours]</td>
                  <td>
                    <span data-invoice-total>[itemTotal]</span> €</td>
                </tr>
              </tbody>
            </table>

            <!-- Summary -->
            <div class="invoice__summary">
              <div class="invoice__summary-row">
                <span>Subtotal:</span>
                <span>
                  <span data-invoice-total>[subtotal]</span> €</span>
              </div>
              <div class="invoice__summary-row">
                <span>VAT:</span>
                <span>0 %</span>
              </div>
              <div class="invoice__summary-row invoice__summary-row--total">
                <span>Invoice total:</span>
                <span>
                  <span data-invoice-total>[total]</span> €</span>
              </div>
            </div>
          </es-stack>

          <!-- Payment Information -->
          <es-stack gap="xs">
            <div>
              <strong>Invoice to be paid to</strong> Emanuel André Pais Saramago
            </div>
            <div>
              <strong>IBAN:</strong> PT50 0269 0391 00206138969 13
            </div>
            <div>
              <strong>BIC/SWIFT:</strong> BKBKPTPL
            </div>
          </es-stack>
        </div>
      </Card>
    </es-stack>
  </div>
</Layout>

<style scoped>

  /* Invoice Styles */
  .invoice-container {
    display: flex;
    flex-direction: column;
    gap: var(--sl-spacing-medium);
  }

  .invoice {
    width: 210mm;
    min-height: 297mm;
    background-color: #fff;
    color: #000;
    padding: 20mm;
    box-sizing: border-box;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: var(--sl-spacing-large);
    font-size: 1.4rem;
    line-height: 1.6;
  }

  .invoice__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--sl-spacing-large);
  }

  .invoice__title {
    font-size: 4rem;
    font-weight: 700;
    text-transform: uppercase;
    margin: 0;
    letter-spacing: 0.05em;
  }

  .invoice__header-info {
    text-align: right;
    font-size: 1.4rem;
    line-height: 1.8;
  }

  .invoice__from,
  .invoice__billed-to,
  .invoice__payment {
    margin-bottom: var(--sl-spacing-medium);
  }

  .invoice__section-label {
    font-weight: 600;
    margin-bottom: var(--sl-spacing-x-small);
    font-size: 1.4rem;
  }

  .invoice__address {
    font-size: 1.4rem;
    line-height: 1.8;
  }

  .invoice__address > div {
    margin-bottom: 0.2rem;
  }

  thead {
    background-color: #f5f5f5;
    color-adjust: exact !important;
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
  }

  th {
    padding: var(--sl-spacing-small);
    text-align: end;
    font-weight: 600;
    font-size: 1.4rem;
    border-bottom: 1px solid #ddd;
    white-space: nowrap;
    &:first-child {
      text-align: start;
      white-space: normal;
    }
  }

  td {
    padding: var(--sl-spacing-small);
    font-size: 1.4rem;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    text-align: end;
    &:first-child {
      text-align: start;
      white-space: normal;
    }
  }

  .invoice__summary {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--sl-spacing-x-small);
    margin-left: auto;
    margin-inline-end: 1rem;
    width: fit-content;
  }

  .invoice__summary-row {
    display: flex;
    justify-content: space-between;
    gap: var(--sl-spacing-medium);
    width: 200px;
    font-size: 1.4rem;
  }

  .invoice__summary-row--total {
    font-weight: 700;
    font-size: 1.6rem;
    margin-top: var(--sl-spacing-x-small);
    padding-top: var(--sl-spacing-x-small);
    border-top: 1px solid #000;
  }

  .invoice__actions {
    display: flex;
    justify-content: center;
    margin-top: var(--sl-spacing-medium);
  }

  /* Print Styles */
  @media print {
    * {
      visibility: hidden;
    }
    .invoice *,
    .invoice {
      visibility: visible;
    }
  }

</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {

    const invoiceForm = document.querySelector('#invoiceForm') as HTMLFormElement
    setDefaultValues()

    document.getElementById('printButton').addEventListener('click', () => {
      window.print()
    })

    function setDefaultValues() {
      const today = new Date()
      const date = formatDate(today)
      const month = getLastMonth(today)
      const dateInput = document.getElementById('date') as HTMLInputElement
      const monthInput = document.getElementById('month') as HTMLInputElement
      dateInput.value = date
      monthInput.value = month
    }

    const inputFields = invoiceForm.querySelectorAll('input, select') as NodeListOf<HTMLInputElement | HTMLSelectElement>
    const selectFields = invoiceForm.querySelectorAll('select') as NodeListOf<HTMLSelectElement>

    
    inputFields.forEach(field => {

      field.addEventListener('input', (event) => {
        updateInvoice(event.target as HTMLInputElement)
      })

      updateInvoice(field as HTMLInputElement)
    })

    selectFields.forEach(field => {
      field.addEventListener('change', (event) => {
        updateInvoice(event.target as HTMLSelectElement)
      })
      updateInvoice(field as HTMLSelectElement)
    })

    function updateInvoice(field: HTMLInputElement | HTMLSelectElement) {
      if (!field) return
      const fieldName = field.name as string
      if (!fieldName) return

      const value = formatValue(fieldName, field.value as string)

      const invoiceElement = document.querySelector(`[data-invoice-${fieldName}]`) as HTMLElement
      if (invoiceElement) {
        invoiceElement.textContent = value
      } else {
        console.warn(`No invoice element found for field: ${fieldName}`)
      }
    }

    function formatValue(fieldName: string, value: string): string {
      let formattedValue = value
    
      if (fieldName === 'month') {
        formattedValue = new Date(value).toLocaleDateString('en-GB', {
          month: 'long',
          year: 'numeric',
        })
      } else if (fieldName === 'date') {
        formattedValue = new Date(value).toLocaleDateString('en-GB', {
          day: 'numeric',
          month: 'long',
          year: 'numeric',
        })
      } else if (fieldName === 'hours' || fieldName === 'unit-price') {

        const hourlyRate = document.getElementById('hourlyRate') as HTMLInputElement
        const hours = document.getElementById('hours') as HTMLInputElement
        if (hourlyRate && hours) {
          const total = Number(hourlyRate.value) * Number(hours.value)
          const totalFields = document.querySelectorAll('[data-invoice-total]') as NodeListOf<HTMLElement>
          if (totalFields) {
            totalFields.forEach(field => {
              field.textContent = total.toString()
            })
          }
        }
      
      }

      return formattedValue
    }

    function formatDate(date: Date): string {
      const formattedDate = date.toISOString().split('T')[0]
      return formattedDate
    }
    function getLastMonth(date: Date): string {
      const dateParts = date.toISOString().split('-')
      const formattedMonth = `${dateParts[0]}-${Number(dateParts[1]) - 1}`
      return formattedMonth
    }

  });
</script>